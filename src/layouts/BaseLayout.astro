---
import MainHead from '../components/MainHead.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';

interface Props {
	title?: string | undefined;
	description?: string | undefined;
	image?: string | undefined;
	imageAlt?: string | undefined;
	ogType?: 'website' | 'article';
	article?: {
		publishedTime?: string;
		modifiedTime?: string;
		expirationTime?: string;
		authors?: string[];
		section?: string;
		tags?: string[];
	};
	structuredData?: Record<string, unknown> | Array<Record<string, unknown>>;
}

const { title, description, image, imageAlt, ogType, article, structuredData } = Astro.props;
---

<html lang="pt-BR">
	<head>
		<script is:inline>document.documentElement.classList.add('js');</script>
	<script is:inline type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-0XZV7NBH4E"></script>
	<script is:inline type="text/partytown">
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'G-0XZV7NBH4E');
		</script>
		<script is:inline>
			const setLoadedClass = () => document.documentElement.classList.add('loaded');

			if (document.readyState === 'loading') {
				document.addEventListener(
					'DOMContentLoaded',
					() => requestAnimationFrame(setLoadedClass),
					{ once: true }
				);
			} else {
				requestAnimationFrame(setLoadedClass);
			}
		</script>
                <MainHead
                        title={title}
                        description={description}
                        image={image}
                        imageAlt={imageAlt}
                        ogType={ogType}
                        article={article}
                        structuredData={structuredData}
                />
	</head>
	<body>
		<div class="stack backgrounds">
			<Nav />
			<slot />
			<Footer />
		</div>

		<script>
			// Scroll Reveal Animation System
			function initScrollReveal() {
				const animatedElements = document.querySelectorAll('[data-animate]');
				if (!animatedElements.length) return;

				const revealAll = () => {
					animatedElements.forEach(el => el.classList.add('is-visible'));
				};

				const revealInView = (elements) => {
					elements.forEach(el => {
						const rect = el.getBoundingClientRect();
						if (rect.top < window.innerHeight && rect.bottom > 0) {
							el.classList.add('is-visible');
						}
					});
				};

				const setupScrollFallback = () => {
					let ticking = false;
					const onScroll = () => {
						if (ticking) return;
						ticking = true;
						requestAnimationFrame(() => {
							ticking = false;
							const hidden = document.querySelectorAll('[data-animate]:not(.is-visible)');
							if (!hidden.length) {
								window.removeEventListener('scroll', onScroll);
								window.removeEventListener('resize', onScroll);
								return;
							}
							revealInView(hidden);
						});
					};
					window.addEventListener('scroll', onScroll, { passive: true });
					window.addEventListener('resize', onScroll);
					onScroll();
				};

				try {
					const matchMedia = window.matchMedia ? window.matchMedia.bind(window) : null;
					const prefersReducedMotion = matchMedia
						? matchMedia('(prefers-reduced-motion: reduce)').matches
						: false;

					if (prefersReducedMotion) {
						revealAll();
						return;
					}

					if (!('IntersectionObserver' in window)) {
						setupScrollFallback();
						return;
					}

					const elementsToObserve = [];

					animatedElements.forEach(el => {
						const rect = el.getBoundingClientRect();
						const isInView = rect.top < window.innerHeight && rect.bottom > 0;

						if (isInView) {
							el.classList.add('is-visible');
						} else {
							elementsToObserve.push(el);
						}
					});

					if (!elementsToObserve.length) return;

					const observer = new IntersectionObserver(
						(entries) => {
							entries.forEach(entry => {
								if (entry.isIntersecting) {
									entry.target.classList.add('is-visible');
									observer.unobserve(entry.target);
								}
							});
						},
						{
							threshold: 0.1,
							rootMargin: '0px 0px -50px 0px'
						}
					);

					elementsToObserve.forEach(el => observer.observe(el));

					// Safety fallback: if nothing is revealed shortly after load, use scroll fallback.
					window.setTimeout(() => {
						const hidden = document.querySelectorAll('[data-animate]:not(.is-visible)');
						if (hidden.length) {
							revealInView(hidden);
							setupScrollFallback();
						}
					}, 500);
				} catch (error) {
					setupScrollFallback();
				}
			}

			const runReveal = () => initScrollReveal();

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', runReveal, { once: true });
			} else {
				runReveal();
			}

			window.addEventListener('pageshow', runReveal, { once: true });
			window.addEventListener('load', runReveal, { once: true });
		</script>
		<script is:inline nomodule>
			(function () {
				var elements = document.querySelectorAll('[data-animate]');
				for (var i = 0; i < elements.length; i += 1) {
					elements[i].classList.add('is-visible');
				}
			})();
		</script>

		<style>
			:root {
				--bg-noise: url('/assets/backgrounds/noise.png');
				--bg-ambient-1: radial-gradient(
					1200px 600px at 6% -10%,
					rgba(47, 111, 109, 0.16),
					transparent 60%
				);
				--bg-ambient-2: radial-gradient(
					900px 500px at 92% 10%,
					rgba(28, 42, 58, 0.12),
					transparent 55%
				);
				--bg-ambient-3: radial-gradient(
					1000px 700px at 50% 110%,
					rgba(143, 182, 198, 0.12),
					transparent 60%
				);
				--bg-glow: radial-gradient(
					800px 500px at 40% 0%,
					rgba(47, 111, 109, 0.08),
					transparent 60%
				);
				--bg-base: linear-gradient(180deg, var(--gray-999) 0%, #efe7e0 100%);
			}

			:root.theme-dark {
				--bg-ambient-1: radial-gradient(
					1200px 600px at 6% -10%,
					rgba(90, 154, 166, 0.2),
					transparent 60%
				);
				--bg-ambient-2: radial-gradient(
					900px 500px at 92% 10%,
					rgba(43, 58, 70, 0.16),
					transparent 55%
				);
				--bg-ambient-3: radial-gradient(
					1000px 700px at 50% 110%,
					rgba(90, 154, 166, 0.12),
					transparent 60%
				);
				--bg-glow: radial-gradient(
					900px 600px at 40% 0%,
					rgba(90, 154, 166, 0.12),
					transparent 60%
				);
				--bg-base: linear-gradient(180deg, var(--gray-999) 0%, #0f0c0a 100%);
			}

			:root.loaded {
				--bg-glow: radial-gradient(
					900px 600px at 40% 0%,
					rgba(47, 111, 109, 0.14),
					transparent 60%
				);
			}
			:root.loaded.theme-dark {
				--bg-glow: radial-gradient(
					900px 600px at 40% 0%,
					rgba(90, 154, 166, 0.18),
					transparent 60%
				);
			}

			.backgrounds {
				min-height: 100%;
				isolation: isolate;
				background:
					var(--bg-noise) top center/200px repeat,
					var(--bg-ambient-1),
					var(--bg-ambient-2),
					var(--bg-ambient-3),
					var(--bg-glow),
					var(--bg-base);
				background-blend-mode: soft-light, normal, normal, normal, normal, normal;
			}
			@media (forced-colors: active) {
				.backgrounds {
					background: none;
					background-blend-mode: none;
				}
			}
		</style>
	</body>
</html>
